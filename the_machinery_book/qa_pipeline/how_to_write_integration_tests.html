<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Write your own integration tests - The Machinery Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li class="chapter-item expanded "><a href="../what_is_the_machinery.html"><strong aria-hidden="true">2.</strong> What is The Machinery</a></li><li class="chapter-item expanded "><a href="../licenses.html"><strong aria-hidden="true">3.</strong> Licenses</a></li><li class="chapter-item expanded "><a href="../getting_started/index.html"><strong aria-hidden="true">4.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/what_is_in_the_package.html"><strong aria-hidden="true">4.1.</strong> What is in this package</a></li><li class="chapter-item expanded "><a href="../getting_started/logging_in.html"><strong aria-hidden="true">4.2.</strong> Sign In</a></li><li class="chapter-item expanded "><a href="../getting_started/new_project.html"><strong aria-hidden="true">4.3.</strong> New Project</a></li><li class="chapter-item expanded "><a href="../getting_started/first_gameplay_project.html"><strong aria-hidden="true">4.4.</strong> First Gameplay Project</a></li><li class="chapter-item expanded "><a href="../getting_started/sample-projects.html"><strong aria-hidden="true">4.5.</strong> Sample Projects</a></li><li class="chapter-item expanded "><a href="../getting_started/troubleshooting.html"><strong aria-hidden="true">4.6.</strong> Troubleshooting</a></li><li class="chapter-item expanded "><a href="../getting_started/migration_from_unity.html"><strong aria-hidden="true">4.7.</strong> The Machinery for Unity Dev's</a></li><li class="chapter-item expanded "><a href="../getting_started/migration_from_unreal.html"><strong aria-hidden="true">4.8.</strong> The Machinery for Unreal 4 Dev's</a></li></ol></li><li class="chapter-item expanded "><a href="../the_editor/index.html"><strong aria-hidden="true">5.</strong> The Editor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../the_editor/tabs.html"><strong aria-hidden="true">5.1.</strong> About Tabs</a></li><li class="chapter-item expanded "><a href="../the_editor/entity_tree_tab.html"><strong aria-hidden="true">5.2.</strong> Entity Tree Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/scene_tab.html"><strong aria-hidden="true">5.3.</strong> Scene Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/properties_tab.html"><strong aria-hidden="true">5.4.</strong> Properties Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/asset_browser.html"><strong aria-hidden="true">5.5.</strong> Asset Browser</a></li><li class="chapter-item expanded "><a href="../the_editor/simulate_tab.html"><strong aria-hidden="true">5.6.</strong> Simulate Tab</a></li><li class="chapter-item expanded "><a href="../the_editor/preview_tab.html"><strong aria-hidden="true">5.7.</strong> Preview Tab</a></li></ol></li><li class="chapter-item expanded "><a href="../editing_workflows/index.html"><strong aria-hidden="true">6.</strong> Editing Workflows</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../editing_workflows/entities.html"><strong aria-hidden="true">6.1.</strong> Entities</a></li><li class="chapter-item expanded "><a href="../editing_workflows/creation_graphs_asset_pipeline.html"><strong aria-hidden="true">6.2.</strong> Creation graphs and asset pipeline</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../editing_workflows/import_assets.html"><strong aria-hidden="true">6.2.1.</strong> Importing Assets</a></li></ol></li><li class="chapter-item expanded "><a href="../editing_workflows/prototypes.html"><strong aria-hidden="true">6.3.</strong> Prototypes</a></li><li class="chapter-item expanded "><a href="../editing_workflows/simulation.html"><strong aria-hidden="true">6.4.</strong> Simulation</a></li><li class="chapter-item expanded "><a href="../editing_workflows/visual-scripting.html"><strong aria-hidden="true">6.5.</strong> Visual Scripting: Entity Graphs</a></li><li class="chapter-item expanded "><a href="../editing_workflows/physics.html"><strong aria-hidden="true">6.6.</strong> Physics</a></li><li class="chapter-item expanded "><a href="../editing_workflows/animation/index.html"><strong aria-hidden="true">6.7.</strong> Animation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../editing_workflows/animation/animation-state-machine.html"><strong aria-hidden="true">6.7.1.</strong> Animation state machines</a></li></ol></li><li class="chapter-item expanded "><a href="../editing_workflows/sound.html"><strong aria-hidden="true">6.8.</strong> Sound</a></li><li class="chapter-item expanded "><a href="../editing_workflows/publish.html"><strong aria-hidden="true">6.9.</strong> Publish</a></li></ol></li><li class="chapter-item expanded "><a href="../collaboration.html"><strong aria-hidden="true">7.</strong> Collaboration</a></li><li class="chapter-item expanded "><a href="../the_truth/index.html"><strong aria-hidden="true">8.</strong> The Truth</a></li><li class="chapter-item expanded "><a href="../extending_the_machinery/index.html"><strong aria-hidden="true">9.</strong> Extending The Machinery</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../extending_the_machinery/the_plugin_system.html"><strong aria-hidden="true">9.1.</strong> The Plugin System</a></li><li class="chapter-item expanded "><a href="../extending_the_machinery/hot-reloading.html"><strong aria-hidden="true">9.2.</strong> Hot-reloading</a></li><li class="chapter-item expanded "><a href="../extending_the_machinery/plugin-assets.html"><strong aria-hidden="true">9.3.</strong> Plugin assets</a></li><li class="chapter-item expanded "><a href="../extending_the_machinery/write-a-plugin.html"><strong aria-hidden="true">9.4.</strong> Writing a plugin</a></li><li class="chapter-item expanded "><a href="../the_truth/custom_truth_type.html"><strong aria-hidden="true">9.5.</strong> Create a custom Truth Type</a></li></ol></li><li class="chapter-item expanded "><a href="../gameplay_coding/index.html"><strong aria-hidden="true">10.</strong> Gameplay coding</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gameplay_coding/simulate_entry.html"><strong aria-hidden="true">10.1.</strong> Simulate Entry in C</a></li><li class="chapter-item expanded "><a href="../gameplay_coding/extend_the_visual_scripting_language.html"><strong aria-hidden="true">10.2.</strong> Extending the visual scripting language</a></li><li class="chapter-item expanded "><a href="../gameplay_coding/ecs/index.html"><strong aria-hidden="true">10.3.</strong> Entity Component System</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gameplay_coding/ecs/write_a_custom_component.html"><strong aria-hidden="true">10.3.1.</strong> Write a custom component</a></li><li class="chapter-item expanded "><a href="../gameplay_coding/ecs/write_a_system_or_engine.html"><strong aria-hidden="true">10.3.2.</strong> Write a Systems &amp; Engines</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../qa_pipeline/index.html"><strong aria-hidden="true">11.</strong> QA Pipeline</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../qa_pipeline/how_to_write_unit_tests.html"><strong aria-hidden="true">11.1.</strong> Write your own unit tests</a></li><li class="chapter-item expanded "><a href="../qa_pipeline/how_to_write_integration_tests.html" class="active"><strong aria-hidden="true">11.2.</strong> Write your own integration tests</a></li></ol></li><li class="chapter-item expanded "><a href="../helper_tools/index.html"><strong aria-hidden="true">12.</strong> Helper Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../helper_tools/tmbuild.html"><strong aria-hidden="true">12.1.</strong> How to use tmbuild</a></li><li class="chapter-item expanded "><a href="../helper_tools/hash.html"><strong aria-hidden="true">12.2.</strong> How to use hash</a></li></ol></li><li class="chapter-item expanded "><a href="../writing_an_executable.html"><strong aria-hidden="true">13.</strong> Writing an executable</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The Machinery Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-to-write-integration-tests"><a class="header" href="#how-to-write-integration-tests">How to write integration tests</a></h1>
<p>This walkthrough shows you how to write integration tests with our integration test framework. You will learn about:</p>
<ul>
<li>How an integration test differs from a unit test.</li>
<li>Where to find the integration test framework and how to write a test</li>
<li>How to run an integration test.</li>
</ul>
<h2 id="about-integration-tests"><a class="header" href="#about-integration-tests"><strong>About integration tests</strong></a></h2>
<p>Integration testing is the phase in testing software in which individual software modules are combined and tested as a group. Integration testing is conducted to evaluate a system's compliance or its interaction as a whole within specified functional requirements. 
Its generally used after unit testing to ensure that the composition of the software works. It is a potent tool to validate certain bugs that are hard to reproduce only after using software extensively. You can simulate this with integration tests. Besides, it is a very powerful tool validating that a bug fix was successful.</p>
<p>By their very nature, integration tests are slower and more fragile than unit tests, but they can also find issues that are hard to detect with regular unit tests. Each integration test runs in a specific &quot;context&quot;, identified by a string hash. The context specifies the &quot;scaffolding&quot; is set up before the unit test runs.</p>
<h2 id="how-to-write-integration-tests-1"><a class="header" href="#how-to-write-integration-tests-1"><strong>How to write integration tests</strong></a></h2>
<p><strong>Where to find the integration test framework?</strong></p>
<p>The integration test framework can be found in the <a href="#">integration_test.h</a> ,and is part of the foundation library. We need to include this header file, and then we can start writing our tests.</p>
<pre><code>#include &lt;foundation/integration_test.h&gt;
</code></pre>
<p>To write a test you need to register it via the <a href="http://#">TM_INTEGRATION_TEST_INTERFACE_NAME</a>. It expects a pointer of the type <a href="http://#">tm_integration_test_i</a>. This interface expects a name and a function pointer to the test function (tick). Also, it expects a context. The context is a string hash. For example: <code>TM_INTEGRATION_TEST_CONTEXT__THE_MACHINERY_EDITOR</code>.</p>
<pre><code class="language-c">// Interface for integration tests.
typedef struct tm_integration_test_i
{
    // Name of the test.
    const char *name;
    // Context that this test will run in. Tests will only be run in contexts that match their
    // `context` setting.
    tm_strhash_t context;
    // Ticks the test. The `tick()` function will be called repeatedly until all it's `wait()` calls
    // have completed.
    void (*tick)(tm_integration_test_runner_i *);
} tm_integration_test_i;
</code></pre>
<p>At this point, we have not tackled the following possible questions:</p>
<ul>
<li>Where and how do we register the interface?</li>
<li>How could this interface look like?</li>
<li>How does a test itself look like?</li>
</ul>
<p><strong>Let us walk those questions through:</strong></p>
<p><em>Where and how do we register the interface?</em></p>
<p>We need to register our tests in the same function as everything else that needs to be executed when a plugin loads: in our <code>tm_load_plugin</code>.</p>
<pre><code class="language-c">// my amazing plugin
TM_DLL_EXPORT void tm_load_plugin(struct tm_api_registry_api *reg, bool load)
{
    tm_global_api_registry = reg;
    //...
    tm_add_or_remove_implementation(reg, load, TM_INTEGRATION_TEST_INTERFACE_NAME, my_integration_tests);
}
</code></pre>
<p>Here we register our test interface to the <code>TM_INTEGRATION_TEST_INTERFACE_NAME</code>.</p>
<p><em>How could this interface look like?</em></p>
<p>After we have done this, we need to declare our <code>my_integration_tests.</code> </p>
<pre><code class="language-c">tm_integration_test_i my_integration_tests = {
    .name = &quot;stress-test&quot;,
    //Context that specifies a running The Machinery editor application
    .context = TM_INTEGRATION_TEST_CONTEXT__THE_MACHINERY_EDITOR,
    .tick = my_test_tick,
};
</code></pre>
<p>The name field is important because, later on, we need to use this name when we want to run the test. The context makes sure that it runs and boots up the Editor. <code>TM_INTEGRATION_TEST_CONTEXT__THE_MACHINERY_EDITOR</code> is defined in <code>#include &lt;foundation/integration_test.h&gt;</code>. The function <code>my_test_tick</code> gets called and the magic can happen.</p>
<p><em>How does a test itself look like?</em></p>
<p>Let us write this test. We need to write a function of the signature: <code>(tm_integration_test_runner_i *)</code>.  In its body, we can define our tests.</p>
<pre><code class="language-c">static void my_test_tick(tm_integration_test_runner_i *test_runner)
{
  //.. code
}
</code></pre>
<p>The test runner variable <code>test_runner</code> is needed to communicate back to the test suite about failures etc.  The following <a href="http://#">macros</a> will help you write tests. They are the heart of the tests.</p>
<table><thead><tr><th><strong>Macro</strong></th><th><strong>Arguments</strong></th><th><strong>Description</strong></th></tr></thead><tbody>
<tr><td>TM_WAIT</td><td>test_runner, second</td><td>Waits for the specified time inside an integration test.</td></tr>
<tr><td>TM_WAIT_LOOP</td><td>test_runner, second, i</td><td>Since <code>TM_WAIT()</code> uses the <code>__LINE__</code> macro to uniquely identify wait points, it doesn't work when called in a loop. In this case you can use <code>TM_WAIT_LOOP()</code> instead. It takes an iteration parameter <code>i</code> that uniquely identifies this iteration of the loop (typically it would just be the iteration index). This together with <code>__LINE__</code> gives a unique identifier for the wait point.</td></tr>
</tbody></table>
<blockquote>
<p><strong><code>TM_WAIT_LOOP</code> WARNING</strong></p>
<p>If you have multiple nested loops, be aware that using just the inner loop index j is not enough to uniquely identify the wait point since it is repeated for each outer loop iteration. Instead, you want to combine the outer and inner indexes.</p>
</blockquote>
<p>Lets write some example:</p>
<pre><code class="language-c">#include &lt;foundation/integration_test.h&gt;
static void my_test_tick(tm_integration_test_runner_i *test_runner)
{
    const float step_time = 0.5f;
    if (TM_WAIT(tr, step_time))
    open(tr, &quot;C:\\work\\sample-projects\\modular-dungeon-kit\\project.the_machinery_dir&quot;);
    if (TM_WAIT(tr, step_time))
    save_to_asset_database(tr, &quot;C:\\work\\sample-projects\\modular-dungeon-kit\\modular-dungeon-kit.the_machinery_db&quot;);
    // ...
}
</code></pre>
<h2 id="how-do-we-run-an-integration-test"><a class="header" href="#how-do-we-run-an-integration-test"><strong>How do we run an integration test?</strong></a></h2>
<p>To run your newly created integration test, we need to build the project via tmbuild. Then start The Machinery with the <code>-t/--test [NAME]</code> parameter. It runs the specified integration test. </p>
<blockquote>
<p>You can use multiple --test arguments to run multiple tests. This will boot up the engine and run your integration tests.</p>
</blockquote>
<p><em>Example:</em></p>
<pre><code>./bin/the-machinery.exe --test stress-test
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../qa_pipeline/how_to_write_unit_tests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../helper_tools/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../qa_pipeline/how_to_write_unit_tests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../helper_tools/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
